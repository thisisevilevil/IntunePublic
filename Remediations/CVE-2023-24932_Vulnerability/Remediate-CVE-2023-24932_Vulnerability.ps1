<#
This remediation script will detect if protection against CVE-2023-24932 have been applied.
If not, we will proceed to remediation and apply the relevant reg keys

Only supports Windows 10 22H2 and Windows 11 22H2 so far.

NOTE: Protection will only take effect after 2 reboots has been applied

#>


$targetregkey = 'HKLM:\SYSTEM\CurrentControlSet\Control\Secureboot'
$targetname = 'AvailableUpdates'
$targetvalue = '48'
$customer = 'InsertName'
$deploymentkey = "HKLM:\SOFTWARE\$customer"


function assesreadiness {
$fixok = $false
$CurrentBuild = (Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion' -Name CurrentBuild).CurrentBuild
$UBR = (Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion' -Name UBR).UBR
    
$securebootstatus = Confirm-SecureBootUEFI
if (!($securebootstatus -eq $true)) {Write-output "SecureBoot is not enabled on this device. Unable to continue" ; exit 1}
    
#Windows 11 22H2
if ($currentbuild -eq '22621') {
    if ($UBR -ge '1992') {Write-output "Device already running July 2023 patch or later. Should be ok to apply SecureBoot security fix"
    $fixok = $true}
}
    
#Windows 10 22H2
if ($currentbuild -eq '19045') {
    if ($UBR -ge '3208') {Write-output "Device already running July 2023 patch or later. Should be ok to apply SecureBoot security fix"
    $fixok = $true}
    }
    
if ($fixok -eq $true) {
    Write-output "OS Pre-reqs for applying secureboot fix should be met."}
    else {Write-output "OS pre-req for applying fix is not met. Please update OS to latest build" ; exit 1}
    
}
assesreadiness

#Check if the fix has already been deployed on this device (This is a very crude way of doing it.. will try and find an improved way of checking if update has been applied)
if (!(Test-path $deploymentkey)) {New-Item $deploymentkey -Force}
New-ItemProperty -Path $deploymentkey -Name 'SecureBootFix' -Value 'Deployed' -PropertyType String -Force

Try {
Set-ItemProperty -Path $targetregkey -Name $targetname -Value $targetvalue -Force
}
    Catch {Write-output "An error occured trying to set the regvalue $targetvalue under $targetregkey"}